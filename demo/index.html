<!doctype html>

<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>

    <title>Burrow Renderer - Demo</title>

    <style>
      html, body {
        height: 100%;
        margin: 0;
      }

      body {
        height: 100%;
        background-color: #222222;
      }

      canvas {
        position: absolute;
        z-index: 0;
        height: 100%;
        width: 100%;
        inset: 0;
        margin: 0;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <canvas></canvas>
    <script type="module">
      import 'https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js';

      import { DeferredRenderer, DebugViewType } from '../dist/deferred-renderer.js';
      import { OrbitCamera } from './orbit-camera.js';

      // Features to enable on the device if available.
      const preferredFeatures = ['texture-compression-bc', 'texture-compression-etc2'];

      const adapter = await navigator.gpu.requestAdapter();

      const requiredFeatures = [];
      for (const feature of preferredFeatures) {
        if (adapter.features.has(feature)) { requiredFeatures.push(feature); }
      }

      const device = await adapter.requestDevice({ requiredFeatures });

      const canvas = document.querySelector('canvas');
      const context = canvas.getContext('webgpu');
      context.configure({
        device,
        format: navigator.gpu.getPreferredCanvasFormat(),
        alphaMode: 'premultiplied',
      });

      const renderer = new DeferredRenderer(device);

      const camera = new OrbitCamera(canvas);
      camera.distance = 3;

      // Debug panel
      const debugPane = new Tweakpane.Pane({
        title: 'Debug',
      });

      debugPane.addBlade({
        label: 'debugView',
        view: 'list',
        options: DebugViewType,
        value: renderer.debugView,
      }).on('change', (ev) => {
        renderer.debugView = ev.value;
      });

      debugPane.addInput(renderer, 'exposure', {
        step: 0.1,
        min: 0.1,
        max: 2.5,
      });

      const stats = {
        fps: 0,
        frameMs: 0
      };

      const statsFolder = debugPane.addFolder({
        title: 'Stats',
        expanded: true,
      });
      statsFolder.addMonitor(stats, 'fps', {
        view: 'graph',
        min: 0,
        max: 90
      });
      statsFolder.addMonitor(stats, 'frameMs', {
        view: 'graph',
        min: 0,
        max: 2
      });



      // Event handlers
      function onResize() {
        const dpr = Math.min(devicePixelRatio, 2);
        canvas.width = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        renderer.resize(canvas.width, canvas.height);
      }
      onResize();
      window.addEventListener('resize', onResize);

      // Frame loop
      let frameCount = 0;
      let lastFrameTime = performance.now();
      function onFrame(timestamp) {
        requestAnimationFrame(onFrame);
        const frameStart = performance.now();
        frameCount++;

        const outputTexture = context.getCurrentTexture();

        renderer.render(outputTexture, camera);

        const frameEnd = performance.now();
        stats.frameMs = frameEnd - frameStart;
        if (frameEnd - lastFrameTime > 1000) {
          lastFrameTime = frameEnd;
          stats.fps = frameCount;
          frameCount = 0;
        }
      }
      requestAnimationFrame(onFrame);
    </script>
  </body>
</html>